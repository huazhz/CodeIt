<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>codeit test drive</title>
	<link rel="stylesheet" href="//ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/css/bootstrap.min.css" />
	<style>
body { background: silver; }
body .container { background: white; }
	</style>
</head>
<body>
	<div class="container">
		<h3>codeit test drive</h3>
		<form class="input form-horizontal">
			<div class="form-group">
				<label class="control-label col-sm-2">ROOMS</label>
				<div class="col-sm-10">
					<select class="rooms form-control">
						<option value="">-</option>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label class="control-label col-sm-2">NAME</label>
				<div class="col-sm-10">
					<select class="name form-control">
						<option value="">-</option>
						<option>a</option>
						<option>b</option>
					</select>
				</div>
			</div>
			<div class="col-sm-6">
				<textarea class="form-control left"></textarea>
			</div>
			<div class="col-sm-6">
				<textarea class="form-control right"></textarea>
			</div>
			<div class="col-sm-12">
				<hr>
			</div>
		</form>
	</div>
<script src="//ajax.aspnetcdn.com/ajax/jquery/jquery-2.1.0.min.js"></script>
<script defer="defer" src="/socket.io/socket.io.js"></script>
<script defer="defer" src="/diff.js"></script>
<script defer="defer" src="//ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/bootstrap.min.js"></script>
<script defer="defer">
$(function () {

var $rooms = $(".form-control.rooms").change(function(e) {
	var room = $rooms.val();
	if (room) {
		console.log('join', room);
		socket.emit("join", room);
	} else {
		socket.emit("leave");
	}
});

var $name = $(".form-control.name").change(function(e) {
	var name = $name.val();
	socket.emit("me", { name: name });
});

$.ajax("/api/room/list", {
	method: "post",
	data: "",
	dataType: "json"
}).then(function(rooms) {
	// console.log(rooms);
	$rooms.empty();
	$("<option>", { text: "-", value: "" }).appendTo($rooms);
	for (var k in rooms)
		$("<option>", { text: k }).appendTo($rooms);
});

var socket = window.socket = io(),
	$left = $("textarea.form-control.left"),
	left = "\n", // left text temp
	$right = $("textarea.form-control.right"),
	right = ""; // right text temp
$left.keyup(function(event) {
	var $this = $(this),
		text = $this.val();
	// console.log(left, text);
	if (text[text.length - 1] != '\n')
		text += "\n";
	
	console.log('emit', JsDiff.createPatch("left", left, text))
	socket.emit("code", JsDiff.createPatch("left", left, text))
	left = text;
});
socket.on("join.others", function(roomies) {
	console.log(roomies);
});
socket.on("join.done", function(room, roomies) {
	console.log(room, roomies);
	$left.val(left = room.content);
});
socket.on("code", function(msg) {
	console.log(msg);
	var old = $left.val(),
		text = JsDiff.applyPatch(old, msg);
	if (text === false) return console.log(old, msg);
	// console.log("'%s' '%s'", old, text);
	$left.val(text);
	left = text + "\r\n";
});
socket.on("time", function(msg) {
	console.log(msg);
});

});
</script>
</body>
</html>
